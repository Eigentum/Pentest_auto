import os
import datetime
import modules.recon as recon
import modules.scanning as scanning
import modules.exploit as exploit
import modules.post_exploit as post_exploit

def create_log_file():
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    log_filename = f"logs/pentest_log_{timestamp}.txt"
    os.makedirs("logs", exist_ok=True)
    with open(log_filename, 'w') as log_file:
        log_file.write(f"[INFO] Log file created at {timestamp}\n")
    return log_filename

def select_stages():
    stages = {
        "Recon" : True,
        "Scanning" : True,
        "Exploit" : False,
        "Post-Exploitation" : False
    }

    print("\n[INFO] Select stages to execute: ")
    print("Enter the corresponding number to toggle stages ON/OFF. Press ENTER when done.")
    stage_list = list(stages.keys())

    while True:
        print("\nStage Options: ")
        for idx, stage in enumerate(stage_list, 1):
            status = "ON" if stages[stage] else "OFF"
            print(f"  {idx}. {stage}: {status}")
        print("  0. Finish selection")

        choice = input("Select an option: ").strip()
        if choice. isdigit():
            choice = int(choice)
            if choice == 0:
                break
            elif 1 <= choice <= len(stage_list):
                selected_stage = stage_list[choice - 1]
                stages[selected_stage] = not stages[selected_stage]
                print(f"[INFO] {selected_stage} toggled {'ON' if stages[selected_stage] else 'OFF'}.")
            else:
                print("[ERROR] Please enter a number.")

                

def main():
    print("[INFO] Start Finding Vulnerabilities...")
    log_file = create_log_file()

    

    print("\n[INFO] Stage Configuration:")
    for stage, is_active in stages.items():
        print(f"    - {stage}: {'Enabled' if is_active else 'Disabled'}")

    if stages["Recon"]:
        print("\n[INFO] Starting Recon...")
        recon.run_recon(log_file)

    if stages["Scanning"]:
        print("\n[INFO] Starting Scanning...")
        scanning.run_scaaning(log_file)

    if stages["Exploit"]:
        print("\n[INFO] Starting Exploit...")
        exploit.run_exploit(log_file)

    print("\n[INFO] Finding Vulnerabilities Completed. Check the log file for details.")

if __name__ == "__main__":
    main()