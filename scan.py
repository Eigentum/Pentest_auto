import requests
import os
import json

def load_config():
    json_file_name = os.path.join("config", "settings.json")
    absolute_path = os.path.abspath(json_file_name)

    try:
        with open(absolute_path, 'r', encoding='utf-8') as json_file:
            return json.load(json_file)
    except FileNotFoundError:
        print(f"[ERROR] JSON ")

def scan_http_methods(config, log_file):
    base_url = config.get("base_url")

    print("\n[INFO] Scanning HTTP Methods...")
    with open(log_file, 'a') as log:
        log.write("\n[INFO] Scanning HTTP Methods...\n")

        try:
            response = requests.options(base_url, timeout=5)
            if "Allow" in response.headers:
                allowed_methods = response.headers["Allow"].split(", ")
                print(f"[INFO] Supported HTTP Methods: {', '.join(allowed_methods)}")
                log.write(f"[INFO] Supported HTTP Methods: {', '.join(allowed_methods)}\n")

                for method in ["PUT", "DELETE", "TRACE", "OPTIONS"]:
                    if method in allowed_methods:
                        print(f"[WARNING] {method} method is enabled. This could be a security risk.")
                        log.write(f"[WARNING] {method} method is enabled. This could be a security risk.\n")
            else:
                print("[INFO] Server did not respond with an 'Allow' header.")
                log.write("[INFO] Server did not respond with an 'Allow' header.\n")
        except requests.RequestException as e:
            print(f"[ERROR] Failed to scan HTTP methods: {e}")
            log.write(f"[ERROR] Failed to scan HTTP methods: {e}\n")

def run_scan(log_file):
    config = load_config()
    if not config:
        return
    base_url = config.get("base_url")
    if not base_url:
        print("[ERROR] Base URL is not defined in the configuration file.")
        return
    
    print("==========================================")
    print("=============== scan start ===============")
    print("==========================================")
    scan_http_methods(config, log_file)